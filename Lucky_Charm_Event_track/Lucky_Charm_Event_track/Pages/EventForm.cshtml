@page
@model Lucky_Charm_Event_track.Pages.EventFormModel
@{
    ViewData["Title"] = "EventForm";
}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewData["Title"] - Event Form</title>
    <link rel="stylesheet" href="~/css/EventForm.css">
    <script src="~/js/event-form.js" defer></script>
</head>

<body>


    <!-- Top Navbar -->
    <div class="top-navbar">
        <div class="navbar-left">
            <img src="~/Images/Green%20Classic%20Four%20Leaf%20Clover%20Geometric%20Logo.png" alt="Logo" class="logo">
        </div>
        <div class="navbar-right">
            <img src="https://icons.veryicon.com/png/o/miscellaneous/250-thick-line-icon-of-website-and-app/6-bell.png" alt="Notifications" class="bell-icon">
            <button class="account-btn">
                <img src="https://cdn-icons-png.flaticon.com/512/847/847969.png" alt="User Avatar" class="account-img">
                    <span class="account-name">@Model.FirstName</span>
            </button>
        </div>
    </div>

    <form id="eventForm" class="event-form">
        <h2>Create New Event</h2>

        <div class="form-group">
            <label for="eventName">Event Name:</label>
            <input type="text" id="eventName" name="eventName" required>
        </div>

        <div class="form-group">
            <label for="eventDate">Date:</label>
            <input type="date" id="eventDate" name="eventDate" required>
        </div>

        <div class="form-group">
            <label for="eventTime">Time:</label>
            <input type="time" id="eventTime" name="eventTime" required>
        </div>

        <div class="form-group">
            <label for="eventLocation">Street Address:</label>
            <input type="text" id="eventLocation" name="eventLocation" required>
        </div>

        <div class="form-group">
            <label for="city">City:</label>
            <input type="text" id="city" name="city" required>
        </div>

        <div class="form-group">
            <label for="region">Province/State:</label>
            <input type="text" id="region" name="region" required>
        </div>

        <div class="form-group">
            <label for="postalCode">Postal Code:</label>
            <input type="text" id="postalCode" name="postalCode" required>
        </div>

        <div class="form-group">
            <label for="country">Country:</label>
            <input type="text" id="country" name="country" required>
        </div>

        <div class="form-group">
            <label for="capacity">Capacity:</label>
            <input type="number" id="capacity" name="capacity" min="1" required>
        </div>

        <div class="form-group">
            <label for="eventType">Event Type:</label>
            <select id="eventType" name="eventType" required>
                <option value="free">Free</option>
                <option value="paid">Paid</option>
            </select>
        </div>

        <div class="form-group" id="priceGroup" style="display:none;">
            <label for="price">Price ($):</label>
            <input type="number" id="price" name="price" min="0" step="0.01" placeholder="Enter price for paid event">
        </div>

        <div class="form-group">
            <label for="category">Category:</label>
            <select id="category" name="category">
                <option value="meeting">Meeting</option>
                <option value="workshop">Workshop</option>
                <option value="conference">Conference</option>
                <option value="social">Social Gathering</option>
                <option value="other">Other</option>
            </select>
        </div>

        <div class="form-group">
            <label for="eventDescription">Description:</label>
            <textarea id="eventDescription" name="eventDescription" rows="5"></textarea>
        </div>

        <div class="button-container">
            <button type="submit">Create Event</button>
            <a href="/" class="cancel-btn">
                <button type="button">Cancel Event</button>
            </a>
        </div>

    </form>

</body>

</html>

<script>

// Show price input only if event type is paid
const eventTypeSelect = document.getElementById("eventType");
const priceGroup = document.getElementById("priceGroup");

eventTypeSelect.addEventListener("change", function() {
    priceGroup.style.display = this.value === "paid" ? "block" : "none";
});

const eventDateInput = document.getElementById("eventDate");
const today = new Date().toISOString().split("T")[0];
eventDateInput.setAttribute("min", today);


// Form submit
document.getElementById('eventForm').addEventListener('submit', async function (e) {
    e.preventDefault();

    const form = e.target;

   const payload = {
    EventName: form.eventName.value,
    EventDescription: form.eventDescription.value,
    StartTime: `${form.eventDate.value}T${form.eventTime.value}`,
    Address: form.eventLocation.value,
    City: form.city.value,
    Region: form.region.value,
    PostalCode: form.postalCode.value,
    Country: form.country.value,
    Capacity: parseInt(form.capacity.value, 10),
    TicketType: form.eventType.value === "paid" ? 0 : 3, 
    IsActive: true,
    Category: form.category.value,
    EventOrganizerId: 1,
    CreatedAt: new Date().toISOString(),
    UpdatedAt: new Date().toISOString(),
    Prices: form.eventType.value === "paid"
        ? [{
            Price: parseFloat(form.price.value),
            TicketType: 0,  
            Label: "Default",
            MaxQuantity: parseInt(form.capacity.value, 10),
            isAvailable: true
        }]
        : [{
            Price: 0,
            TicketType: 3,   
            Label: "Free",
            MaxQuantity: parseInt(form.capacity.value, 10),
            isAvailable: true
        }]
};



    try {
        const response = await fetch('/api/events/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (response.ok) {
            const result = await response.json();
            console.log("Event created:", result);
            window.location.href = "/EventConfirmation";
        } else {
            const error = await response.text();
            console.error("Failed to create event:", error);
            alert("Error creating event.");
        }
    } catch (err) {
        console.error("Network error:", err);
        alert("Network error. Please try again.");
    }
});
</script>

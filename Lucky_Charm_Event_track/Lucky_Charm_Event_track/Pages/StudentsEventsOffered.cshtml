@page
@model Lucky_Charm_Event_track.Pages.StudentsEventsOfferedModel
@{
    ViewData["Title"] = "StudentsEventsOffered";
}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewData["Title"]</title>
    <link rel="stylesheet" href="~/css/studentportal.css">
    <link rel="stylesheet" href="~/css/site.css">

    <style>
        .alert {
            padding: 10px 16px;
            border-radius: 6px;
            margin: 10px 0 20px 0;
            font-weight: 500;
            display: none;
        }

        .alert.success {
            display: block;
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert.error {
            display: block;
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .event-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .event-card {
            background: #fff;
            border-radius: 10px;
            padding: 1.2rem;
            text-align: center;
            transition: transform 0.2s;
        }

        .event-card:hover {
            transform: translateY(-3px);
        }

        .event-card-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 1rem;
        }

        .details-btn,
        .purchase-btn {
            flex: 1;
            border: none;
            border-radius: 8px;
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            font-weight: 600;
            transition: 0.2s ease;
        }

        .interest-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #eee;
            border: none;
            padding: 6px 10px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s, color 0.3s;
        }

        .interest-btn:hover {
            background-color: #f5f5f5;
        }

        .interest-btn.interested {
            background-color: #ff5252;
            color: #fff;
        }

        .toggle-wrapper {
            display: inline-flex;
            align-items: center;
            margin-left: 10px;
            font-size: 1rem; 
            cursor: pointer;
        }

        .toggle-wrapper input[type="checkbox"] {
            display: none;
        }

        .toggle-label {
            margin-top: 4px;
            position: relative;
            display: inline-block;
            width: 70px;   
            height: 34px; 
            margin-right: 12px; 
        }

        .toggle-inner {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            border-radius: 34px; 
            transition: 0.3s;
        }

        .toggle-switch {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 30px; 
            height: 30px;  
            background-color: white;
            border-radius: 50%;
            transition: 0.3s;
        }

        .toggle-wrapper input[type="checkbox"]:checked + .toggle-label .toggle-inner {
            background-color: #912338;
        }

        .toggle-wrapper input[type="checkbox"]:checked + .toggle-label .toggle-switch {
            transform: translateX(36px); 
        }

        .toggle-text {
            font-weight: 700;
            color: #333;
        }

    </style>
</head>
<body>

<!-- Sidebar -->
<div class="sidebar">
    <div class="sidebar-menu">
        <div class="sidebar-item">
            <a asp-page="/StudentsEventsOffered" class="sidebar-link active">
                <img src="~/Images/Untitled design (1)-Photoroom.png" class="sidebar-icon" alt="EventsOffered">
                <span class="sidebar-text">Events Offered</span>
            </a>
        </div>
        <div class="sidebar-item">
            <a asp-page="/StudentsMyTickets" class="sidebar-link">
                <img src="~/Images/86c1865905340afb06ee2948873e0be24974cff4.png" class="sidebar-icon" alt="Events">
                <span class="sidebar-text">Tickets</span>
            </a>
        </div>
       <div class="sidebar-item">
            <a asp-page="/StudentFeedback" class="sidebar-link">
            <img src="~/Images/2508862806f0dced98f9ab1e25e74ce54c4711b2.png" class="sidebar-icon" alt="Feedback">
            <span class="sidebar-text">Feedback</span>
            </a>
        </div>
        <div class="sidebar-item" id="sidebarCreate">
            <a asp-page="/StudentsMyCalendar" class="sidebar-link">
                <img src="~/Images/Untitled design-Photoroom.png" class="sidebar-icon" alt="Calendar">
                <span class="sidebar-text">Calendar</span>
            </a>
        </div>
        <div class="sidebar-bar"></div>
        <div class="sidebar-extra">
            <div class="sidebar-item">
                <img src="~/Images/7965593328e6cb27ffb10553f680443da25fad1a.png" class="sidebar-icon" alt="Organization Settings">
                <span class="sidebar-text">Organization Settings</span>
            </div>
            <div class="sidebar-item" id="logoutBtn" style="cursor:pointer;">
                <img src="~/Images/af7e2a95556abcf8c3cc0c41fedea581cd0f43af.png" class="sidebar-icon" alt="Sign out">
                <span class="sidebar-text">Sign out</span>
            </div>
        </div>
        <div class="sidebar-contact">
            <div class="sidebar-item">
                <img src="~/Images/Untitled%20design.png" class="sidebar-icon" alt="Contact">
                <span class="sidebar-text">Contact</span>
            </div>
        </div>
    </div>
</div>

<!-- Top Navbar -->
<div class="top-navbar">
    <div class="navbar-left">
        <img src="~/Images/Green%20Classic%20Four%20Leaf%20Clover%20Geometric%20Logo.png" alt="Logo" class="logo">
    </div>
    <div class="navbar-right">
        <img src="https://icons.veryicon.com/png/o/miscellaneous/250-thick-line-icon-of-website-and-app/6-bell.png" alt="Notifications" class="bell-icon">
        <button class="account-btn">
            <img src="https://cdn-icons-png.flaticon.com/512/847/847969.png" alt="User Avatar" class="account-img">
                <span class="account-name">@Model.FirstName</span>
        </button>
    </div>
</div>

<!-- Main Content -->
<div class="main-content">
    <div class="main-content-header">
        <h1>Events Offered</h1>
    </div>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert success" id="alertMessage">@TempData["SuccessMessage"]</div>
    }
    else if (TempData["ErrorMessage"] != null)
    {
        <div class="alert error" id="alertMessage">@TempData["ErrorMessage"]</div>
    }

    <!-- Filters -->
    <form method="get" class="search-sort-bar">
        <input type="text" name="SearchQuery" placeholder="Search events..." value="@Model.SearchQuery" />
        <select name="SortByDate">
            <option value="">Sort by Date</option>
            <option value="asc" selected="@(Model.SortByDate=="asc" ? "selected" : null)">Earliest First</option>
            <option value="desc" selected="@(Model.SortByDate=="desc" ? "selected" : null)">Latest First</option>
        </select>
        <select name="SortByPrice">
            <option value="">Sort by Price</option>
            <option value="asc" selected="@(Model.SortByPrice=="asc" ? "selected" : null)">Low to High</option>
            <option value="desc" selected="@(Model.SortByPrice=="desc" ? "selected" : null)">High to Low</option>
        </select>
        <select name="SortByPopularity">
            <option value="">Sort by Popularity</option>
            <option value="asc" selected="@(Model.SortByPopularity=="asc" ? "selected" : null)">Least to Most</option>
            <option value="desc" selected="@(Model.SortByPopularity=="desc" ? "selected" : null)">Most to Least</option>
        </select>

        <!-- Filter by Category -->
        <select id="category" name="Category">
            <option value="">All Categories</option>
            <option value="meeting" selected="@(Model.Category=="meeting" ? "selected" : null)">Meeting</option>
            <option value="workshop" selected="@(Model.Category=="workshop" ? "selected" : null)">Workshop</option>
            <option value="conference" selected="@(Model.Category=="conference" ? "selected" : null)">Conference</option>
            <option value="social" selected="@(Model.Category=="social" ? "selected" : null)">Social Gathering</option>
            <option value="other" selected="@(Model.Category=="other" ? "selected" : null)">Other</option>
        </select>
        <select name="Organization">
            <option value="">All Organizations</option>
            @foreach (var org in Model.AllOrganizations)
            {
                <option value="@org" selected="@(Model.Organization==org ? "selected" : null)">@org</option>
            }
        </select>
        <select name="Location">
            <option value="">All Locations</option>
            @foreach (var loc in Model.AllLocations)
            {
                <option value="@loc" selected="@(Model.Location==loc ? "selected" : null)">@loc</option>
            }
        </select>
        <input type="number" name="MinPrice" placeholder="Min Price" value="@(Model.MinPrice?.ToString() ?? "")" min="0" />
        <input type="number" name="MaxPrice" placeholder="Max Price" value="@(Model.MaxPrice?.ToString() ?? "")" min="0" />
   
        <button type="submit" formaction="?handler=ApplyFilter">Apply</button>

               <div class="toggle-wrapper">
            <input type="checkbox" id="showFavourites" name="ShowInterestedOnly" value="true" @(Model.ShowInterestedOnly ? "checked" : "") />
            <label for="showFavourites" class="toggle-label">
                <span class="toggle-inner"></span>
                <span class="toggle-switch"></span>
            </label>
                <span class="toggle-text" id="toggleText">@((Model.ShowInterestedOnly) ? "Unfavourites" : "Favourites")</span>
        </div>

        </form>
    

    <!-- Events Grid -->
    @if (!Model.FilteredEvents.Any())
    {
        <p class="no-events">No events match your search or filter criteria.</p>
    }
    else
    {
        <div class="event-grid">
            @foreach (var e in Model.FilteredEvents)
            {
                <div class="event-card">
                    <h3>@e.Name</h3>
                    <p><strong>Date:</strong> @e.Date</p>
                    <p><strong>Location:</strong> @e.Location</p>
                    <p><strong>Price:</strong> @(e.Price == 0 ? "Free" : "$" + e.Price)</p>

                    <div class="event-card-buttons">
                        <button class="details-btn"
                            onclick="openEventsOfferedPopup('@e.Name', '@e.Date', '@e.startTime', '@e.endTime', '@e.Location', '@(e.Price == 0 ? "Free" : "$" + e.Price)', '@e.Description', '@e.TicketsLeft', '@e.Category', '@e.Organization')">
                            View Details
                        </button>
                        @if (e.Price == 0)
                        {
                            <form method="post">
                                <input type="hidden" name="eventId" value="@e.Id" />
                                <button type="submit" formaction="?handler=PurchaseTicket" class="purchase-btn">
                                    Claim Ticket
                                </button>
                            </form>
                        }
                        else
                        {
                            <button type="button" class="purchase-btn" onclick="openPaymentModal('@e.Name', '@e.Price', '@e.Id')">
                                Pay Ticket
                            </button>
                        }

                        <form method="post">
                            <input type="hidden" name="eventId" value="@e.Id" />
                            <button type="submit" formaction="?handler=ToggleInterest" class="interest-btn">
                                @if (e.IsInterested)
                                {
                                    <text>Unfavourite</text>
                                }
                                else
                                {
                                    <text>Favourite</text>
                                }
                            </button>
                        </form>

                    </div>
                </div>
            }
        </div>
    }
</div>

<!-- Event Details Popup -->
<div id="eventsOfferedPopup" class="events-offered-popup">
    <div class="events-offered-popup-content">
        <span class="events-offered-close-btn" onclick="closeEventsOfferedPopup()">&times;</span>
        <h2 id="eventsOfferedName"></h2>
        <p><strong>Date:</strong> <span id="eventsOfferedDate"></span></p>
        <p><strong>Start:</strong> <span id="eventsOfferedStart"></span></p>
        <p><strong>End:</strong> <span id="eventsOfferedEnd"></span></p>
        <p><strong>Location:</strong> <span id="eventsOfferedLocation"></span></p>
        <p><strong>Price:</strong> <span id="eventsOfferedPrice"></span></p>
        <p><strong>Description:</strong> <span id="eventsOfferedDescription"></span></p>
        <p><strong>Tickets Left:</strong> <span id="eventsOfferedTickets"></span></p>
        <p><strong>Category:</strong> <span id="eventsOfferedCategory"></span></p>
        <p><strong>Organization:</strong> <span id="eventsOfferedOrganization"></span></p>
    </div>
</div>

<!-- Mock Payment Popup with Pay and Points -->
<div id="paymentModal" class="modal" style="display:none; position:fixed; z-index:100; left:0; top:0; width:100%; height:100%; background-color: rgba(0,0,0,0.4); overflow-y:auto;">
    <div class="modal-content" style="background-color:#fff; margin:7% auto; padding:20px; border-radius:10px; width:450px; max-height:85vh; overflow-y:auto; box-shadow:0 2px 10px rgba(0,0,0,0.2); position:relative;">
        <span class="close" onclick="closePaymentModal()" style="position:absolute; top:15px; right:15px; font-size:20px; cursor:pointer; color:#aaa;">&times;</span>
        
        <div class="modal-header" style="font-size:18px; font-weight:bold; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
            <span>Mock Payment</span>
                <span id="pointsBalance" style="font-size:0.9rem; color:#555;">Points: @Model.PointBalance</span>
        </div>

        <p id="eventName"></p>
        <p id="eventPoints" style="font-size:0.9rem; color:#555; margin-bottom:12px;"></p>

        <form id="paymentForm" method="post" onsubmit="return validatePaymentForm()">
            <input type="hidden" id="eventIdInput" name="eventId" value="" />

            <label>Cardholder Name</label>
            <input type="text" id="cardName" placeholder="" required style="width:100%; padding:8px; margin-top:6px; margin-bottom:12px; border:1px solid #ccc; border-radius:4px;" />
                
            <label>Card Number</label>
            <input type="text" id="cardNumber" placeholder="XXXX XXXX XXXX XXXX" maxlength="19" required style="width:100%; padding:8px; margin-top:6px; margin-bottom:12px; border:1px solid #ccc; border-radius:4px;" />

            <label>Expiration Date</label>
            <input type="month" id="expiryDate" required style="width:100%; padding:8px; margin-top:6px; margin-bottom:12px; border:1px solid #ccc; border-radius:4px;" />

            <label>CVV / Security Code</label>
            <input type="text" id="cvv" placeholder="XXX" required pattern="\d{3}" maxlength="3" style="width:100%; padding:8px; margin-top:6px; margin-bottom:12px; border:1px solid #ccc; border-radius:4px;" />

            <label>Amount ($)</label>
            <input type="number" id="amountInput" readonly style="width:100%; padding:8px; margin-top:6px; margin-bottom:4px; border:1px solid #ccc; border-radius:4px;" />

            <p style="font-size:0.85rem; color:#555; margin-bottom:12px;">
                Or you can pay with points! $1 = 1 point.
            </p>

                <button type="submit" formaction="?handler=MockPointPay" id="pointsBtn" style="width:100%; background-color:#28a745; color:#fff; border:none; padding:10px; border-radius:6px; font-weight:600; cursor:pointer; margin-bottom:12px;">
                Pay with Points
            </button>
            <label>Save My Payment Details for Easy Checkout Next Time </label>
                <div id="savedetailswrapper">
                    <input type="checkbox" id="savedetailscheckbox">
                </div>
            <button type="submit" formaction="?handler=MockPay" style="width:100%; background-color:#721c24; color:#fff; border:none; padding:10px; border-radius:6px; font-weight:600; cursor:pointer;">Confirm Payment</button>
        </form>
    </div>
</div>

<script>
async function validatePaymentForm() {
    const expiry = document.getElementById("expiryDate").value;
    const cvv = document.getElementById("cvv").value;

    if (expiry) {
        const today = new Date();
        const [year, month] = expiry.split('-').map(Number);
        const expiryDate = new Date(year, month - 1);
        if (expiryDate < new Date(today.getFullYear(), today.getMonth())) {
            alert("Expiration date cannot be in the past.");
            return false;
        }
    }

    if (!/^\d{3,4}$/.test(cvv)) {
        alert("Enter a valid CVV (3 or 4 digits).");
        return false;
    }
    const isChecked = document.getElementById("savedetailscheckbox").checked;
    if(isChecked)
    {
                const form = document.getElementById('paymentForm')
                const payload = {
                    CardHolderName : form.querySelector('#cardName')?.value || '',
                    CardNumber : form.querySelector('#cardNumber')?.value || '',
                    ExpiryDate : form.querySelector('#expiryDate')?.value || '',
                    CVV: form.querySelector('#cvv')?.value || ''
                }
                try
                {
                    const response = await fetch('/api/accounts/savepaymentdetails', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (response.ok) {
                        const result = await response.json();
                        console.log("Payment Details Saved!");
                    } else {
                        const error = await response.text();
                        console.error("Failed to Save Payment Details:", error);
                        alert("Error Saving Payment Details: " + error);
                    }   
                }
                catch(error)
                {
                    console.error("Network or server error:", error);
                    alert("Something went wrong. Please try again.");
                }
    }
    return true;
}
window.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await fetch('/api/accounts/getpaymentdetails');
                const result = await response.json();

                if (result != null) {
                    document.getElementById('savedetailswrapper').style.display = 'none';
                    document.getElementById("cardName").value = result.cardHolderName;
                    document.getElementById("cardNumber").value = result.cardNumber;
                    document.getElementById("expiryDate").value = result.expiryDate;
                    document.getElementById("cvv").value = result.cvv;
                }
            } catch (error) {
                console.error("Error checking payment details:", error);
            }
});
function openEventsOfferedPopup(name, date, start, end, location, price, description, tickets, category, organization) {
    document.getElementById('eventsOfferedName').innerText = name;
    document.getElementById('eventsOfferedDate').innerText = date;
    document.getElementById('eventsOfferedStart').innerText = start || "N/A";
    document.getElementById('eventsOfferedEnd').innerText = end || "N/A";
    document.getElementById('eventsOfferedLocation').innerText = location;
    document.getElementById('eventsOfferedPrice').innerText = price;
    document.getElementById('eventsOfferedDescription').innerText = description;
    document.getElementById('eventsOfferedTickets').innerText = tickets;
    document.getElementById('eventsOfferedCategory').innerText = category;
    document.getElementById('eventsOfferedOrganization').innerText = organization;

    document.getElementById('eventsOfferedPopup').style.display = 'block';
}

function closeEventsOfferedPopup() {
    document.getElementById('eventsOfferedPopup').style.display = 'none';
}

const paymentModal = document.getElementById("paymentModal");
const eventNameDisplay = document.getElementById("eventName");
const amountInput = document.getElementById("amountInput");
const eventIdInput = document.getElementById("eventIdInput");

function openPaymentModal(eventName, amount, eventId, eventPointsCost = 0, userPoints = 0) {
    document.getElementById("eventName").textContent = "Paying for: " + eventName;
    document.getElementById("amountInput").value = amount;
    document.getElementById("eventIdInput").value = eventId;
    document.getElementById("eventPoints").textContent = "Event Costs: " + eventPointsCost + " points";
    paymentModal.style.display = "block";
}
function closePaymentModal() {
    paymentModal.style.display = "none";
}


window.onclick = function(event) {
    const popup = document.getElementById('eventsOfferedPopup');
    if (event.target === popup) {
        closeEventsOfferedPopup();
    }
    if (event.target === paymentModal) {
        closePaymentModal();
    }
}

const alertBox = document.getElementById("alertMessage");
if (alertBox) {
    setTimeout(() => {
        alertBox.style.transition = "opacity 0.4s";
        alertBox.style.opacity = "0";
        setTimeout(() => alertBox.remove(), 400);
    }, 4000);
}

const favToggle = document.getElementById("showFavourites");
const toggleText = document.getElementById("toggleText");

favToggle.addEventListener("change", () => {
    toggleText.textContent = favToggle.checked ? "Unfavourites" : "Favourites";
    favToggle.closest("form").submit();
});

document.getElementById("logoutBtn")?.addEventListener("click", async () => {
    try {
        const response = await fetch("/api/accounts/logout", { method: "POST" });
        if (response.ok) {
            const result = await response.json();
            alert(result.message);
            window.location.href = result.redirectUrl; 
        } else {
            alert("Failed to sign out. Please try again.");
        }
    } catch (err) {
        console.error("Logout error:", err);
        alert("An error occurred during sign out.");
    }
});

</script>

</body>
</html>

@page
@model Lucky_Charm_Event_track.Pages.StudentsMyCalendarModel
@{
    ViewData["Title"] = "StudentsMyCalendar";
}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewData["Title"]</title>

    <!-- FullCalendar CSS -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet" />

    <!-- Portal CSS -->
    <link rel="stylesheet" href="~/css/studentportal.css">
</head>
<body>

    <!-- ================= Sidebar Navigation ================= -->
    <div class="sidebar">
        <div class="sidebar-menu">

            <!-- Events Offered -->
            <div class="sidebar-item">
                <a asp-page="/StudentsEventsOffered" class="sidebar-link">
                    <img src="~/Images/Untitled design (1)-Photoroom.png" class="sidebar-icon" alt="EventsOffered">
                    <span class="sidebar-text">Events Offered</span>
                </a>
            </div>

            <!-- Tickets -->
            <div class="sidebar-item">
                <a asp-page="/StudentsMyTickets" class="sidebar-link active">
                    <img src="~/Images/86c1865905340afb06ee2948873e0be24974cff4.png" class="sidebar-icon" alt="Events">
                    <span class="sidebar-text">Tickets</span>
                </a>
            </div>


            <!-- Feedback -->
            <div class="sidebar-item">
                    <a asp-page="/StudentFeedback" class="sidebar-link">
                    <img src="~/Images/2508862806f0dced98f9ab1e25e74ce54c4711b2.png" class="sidebar-icon" alt="Feedback">
                    <span class="sidebar-text">Feedback</span>
                    </a>
                </div>

            <!-- Calendar -->
            <div class="sidebar-item" id="sidebarCreate">
                <a asp-page="/StudentsMyCalendar" class="sidebar-link">
                    <img src="~/Images/Untitled design-Photoroom.png" class="sidebar-icon" alt="Calendar">
                    <span class="sidebar-text">Calendar</span>
                </a>
            </div>

            <div class="sidebar-bar"></div>

            <!-- Extra Sidebar Items -->
            <div class="sidebar-extra">
                <div class="sidebar-item">
                    <img src="~/Images/7965593328e6cb27ffb10553f680443da25fad1a.png" class="sidebar-icon" alt="Organization Settings">
                    <span class="sidebar-text">Organization Settings</span>
                </div>
                <div class="sidebar-item">
                    <img src="~/Images/af7e2a95556abcf8c3cc0c41fedea581cd0f43af.png" class="sidebar-icon" alt="Sign out">
                    <span class="sidebar-text">Sign out</span>
                </div>
            </div>

            <!-- Contact -->
            <div class="sidebar-contact">
                <div class="sidebar-item">
                    <img src="~/Images/Untitled%20design.png" class="sidebar-icon" alt="Contact">
                    <span class="sidebar-text">Contact</span>
                </div>
            </div>
        </div>
    </div>

    <!-- ================= Top Navigation Bar ================= -->
    <div class="top-navbar">
        <div class="navbar-left">
            <img src="~/Images/Green%20Classic%20Four%20Leaf%20Clover%20Geometric%20Logo.png" alt="Logo" class="logo">
        </div>
        <div class="navbar-right">
            <img src="https://icons.veryicon.com/png/o/miscellaneous/250-thick-line-icon-of-website-and-app/6-bell.png" 
                 alt="Notifications" 
                 class="bell-icon">
            <button class="account-btn">
                <img src="https://cdn-icons-png.flaticon.com/512/847/847969.png" alt="User Avatar" class="account-img">
                <span class="account-name">@Model.FirstName</span>
            </button>
        </div>
    </div>

    <!-- ================= Main Content ================= -->
     <div class="main-content">
        <div class="main-content-header">
            <h1>My Calendar</h1>
        </div>

        <div id="calendar"></div>

        <div id="eventPopup">
            <button class="popup-close-btn" onclick="closePopup()">Ã—</button>

            <h2 id="popupTitle"></h2>
            <p><strong>Status:</strong> <span id="popupStatus"></span></p>
            <p><strong>Start:</strong> <span id="popupStart"></span></p>
            <p><strong>Location:</strong> <span id="popupLocation"></span></p>
            <p><strong>Description:</strong> <span id="popupDescription"></span></p>
            <p><strong>Organizer:</strong> <span id="popupOrganizer"></span></p>
            <p><strong>Category:</strong> <span id="popupCategory"></span></p>

            <button class="close-inline-btn" id="removeEventBtn">Remove Event</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
    <script src="~/js/studentportal.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', function () {
        const calendarEl = document.getElementById('calendar');
        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            editable: false,
            eventClick: function(info) {
                const now = new Date();
                let status = info.event.extendedProps.status;

                status = status.charAt(0).toUpperCase() + status.slice(1);

                document.getElementById('popupTitle').innerText = info.event.title;
                document.getElementById('popupStatus').innerText = status;
                document.getElementById('popupStart').innerText = info.event.start?.toLocaleString() || 'N/A';
                document.getElementById('popupLocation').innerText = info.event.extendedProps.location || 'N/A';
                document.getElementById('popupDescription').innerText = info.event.extendedProps.description || 'N/A';
                document.getElementById('popupOrganizer').innerText = info.event.extendedProps.organizer || 'N/A';
                document.getElementById('popupCategory').innerText = info.event.extendedProps.category || 'N/A';
                document.getElementById('eventPopup').style.display = 'block';

                document.getElementById('removeEventBtn').onclick = async function() {
                    const userId = @Model.UserId; 
                    const response = await fetch(`/api/tickets/hide-by-event?eventId=${info.event.extendedProps.eventId}&userId=${userId}`, { method: 'POST' });
                    const data = await response.json();
                    if(data.success) {
                        info.event.remove();
                        closePopup();
                    } else {
                        alert("Error hiding event: " + (data.error || "Unknown error"));
                    }
                };
            }

        });

const events = @Html.Raw(Model.GetEventsJson());
const eventIds = new Set();

events.forEach(e => {
    if (!eventIds.has(e.id)) {
        let color = e.status === 'finished' ? '#d3d3d3' : '';

        // Convert start to Date objects
        let startDate = new Date(e.start);
        let endDate = e.end ? new Date(e.end) : new Date(startDate.getTime() + 60*60*1000);

        calendar.addEvent({
            id: e.id,
            title: e.title,
            start: startDate,
            end: endDate,
            allDay: e.allDay, 
            description: e.description,
            location: e.location,
            organizer: e.organizer,
            category: e.category,
            status: e.status,
            color: color,
            eventId: e.eventId
        });

        eventIds.add(e.id);
    }
});


        calendar.render();
    });

    function closePopup() {
        document.getElementById('eventPopup').style.display = 'none';
    }
    </script>
</body>
</html>
